#!/bin/bash

# The script let remane ethernet interfaces
#

LOG_FILE='/var/log/let-rename.log'
NET_CONF_FILE='/etc/network/interfaces'

get_eth_interfaces() {
for DEV in /sys/class/net/* ; do
   # Take only links into account, skip files
   if [ ! -L $DEV ]; then
         continue
    fi
    DEVPATH=$(readlink -f $DEV)
    # Drop virtual devices like loopback, tunnels, bonding, vlans ...
      case $DEVPATH in
           */virtual/*)
               continue
        ;;
      esac
      IF=${DEVPATH##*/}
      # Check ethernet only
      case "$(cat $DEV/type)" in
          1)
              # TYPE=1 is ethernet, may also be wireless
              # Virtual (lo, bound, vlan, tunnel ...) have been skipped before
              if [ -d $DEV/wireless -o -L $DEV/phy80211 ]; then
                  continue
              else
                  # Catch ethernet non-virtual device
                  echo $IF
              fi
          ;;
          *)
              continue
          ;;
      esac
done
}

get_interface_name_by_mac() {
  local mac="$1"
  if [ -z $mac ] ; then
     exit 1;
  fi
  for DEV in /sys/class/net/* ; do
    DEVPATH=$(readlink -f $DEV)
    if [ "$mac" == "$(cat $DEV/address)" ] ; then
       echo "${DEVPATH##*/}"
       break
    else
       continue
    fi
  done
}

for intf in $(get_eth_interfaces) ; do
   # Remember old interface name and MAC address
   # The name might be changed due to renaming
   if [ "up" == "$(cat /sys/class/net/$intf/operstate)" ] ; then
       # Remember the interface name and MAC
       oldname="$intf"
       macaddr="$(cat /sys/class/net/$intf/address)"
       echo "$oldname" >> ${LOG_FILE}
       echo "$macaddr" >> ${LOG_FILE}

       # Down interface to let udev rename it
       ifdown "$intf"
       udevadm trigger --subsystem-match=net --action=add
       udevadm settle
       # Get new name based on MAC address of the interface
       newname=$(get_interface_name_by_mac "$macaddr")
       echo "$newname" >> ${LOG_FILE}
       echo "======" >> ${LOG_FILE}
       # Work-around for renaming interface in config files
       sed -i -e "s/$oldname/$newname/g" $NET_CONF_FILE
       ifup $newname
   fi
done
exit 0

