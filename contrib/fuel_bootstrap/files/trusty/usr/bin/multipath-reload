#!/bin/bash -x

LOG_NAME='multipath-reload'
TIMEOUT='360s'
KILL_TIMEOUT='120s'

m_reload(){
   echo 'Perform multipath reloading'
   timeout --kill-after=${KILL_TIMEOUT} ${TIMEOUT} dmsetup remove_all
   timeout --kill-after=${KILL_TIMEOUT} ${TIMEOUT} dmsetup udevcomplete_all -y
   timeout --kill-after=${KILL_TIMEOUT} ${TIMEOUT} multipath -F
   timeout --kill-after=${KILL_TIMEOUT} ${TIMEOUT} multipath -r
}

m_reload 2>&1 | tee -a /var/log/${LOG_NAME}  | /usr/bin/logger -i -t ${LOG_NAME}
